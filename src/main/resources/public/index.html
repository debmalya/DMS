<!DOCTYPE html>
<html>

<head>
  <title>Debmalya Jash</title>
  <style>
    #mapid {
      position: absolute;
      width: 100%;
      height: 100%;
    }
  </style>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.3.4/dist/leaflet.css" integrity="sha512-puBpdR0798OZvTTbP4A8Ix/l+A4dHDD0DGqYW6RQ+9jxkRFclaxxQb/SJAWZfWAkuyeQUytO7+7N4QKrDh+drA=="
    crossorigin />
  <link rel="stylesheet" href="https://unpkg.com/leaflet-control-geocoder/dist/Control.Geocoder.css" />
  <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.0.6/dist/MarkerCluster.css" />
  <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.0.6/dist/MarkerCluster.Default.css" />
  <script src="https://unpkg.com/leaflet@1.3.4/dist/leaflet.js" integrity="sha512-nMMmRyTVoLYqjP9hrbed9S+FzjZHW5gY1TWCHA5ckwXZBadntCNs8kEqAWdrb9O7rxbCaA4lKTIWjDXZxflOcA=="
    crossorigin></script>
  <script src="https://unpkg.com/leaflet-control-geocoder/dist/Control.Geocoder.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet-realtime/2.1.1/leaflet-realtime.min.js"></script>
  <script src="https://unpkg.com/leaflet.markercluster@1.0.6/dist/leaflet.markercluster-src.js"></script>
  <script src="https://unpkg.com/leaflet.featuregroup.subgroup"></script>
</head>

<body>
  <div id="description"></div>
  <div id="mapid"></div>
  <script>
    var map = L.map('mapid').setView([0, 0], 2),
      geocoder = L.Control.Geocoder
      .nominatim(),

      control = L.Control.geocoder({
        geocoder: geocoder
      }),
      realtime = L.realtime({
        url: '/disaster',
        crossOrigin: true,
        type: 'json'
      }, {
        interval: 5 * 1000,

        getFeatureId: function (f) {
          return f.properties.link;
        },
        onEachFeature(f, l) {
          l.bindPopup(function () {
            return '<h6>' + f.properties.description + '</h6>' +
              '<h6><strong>' + f.properties.status + '</strong></h6>' +
              '<p>' + f.properties.date +
              '<p><a href="' + f.properties.link + '">More information</a></p>';
          });
        }
      })
      .addTo(map),
      marker;

    realtime.on('update', function () {
      map.fitBounds(realtime.getBounds(), {
        maxZoom: 3
      });
      markers = L.markerClusterGroup({
        iconCreateFunction: function (cluster) {
          return L.divIcon({
            html: '<b>' + cluster.getChildCount() + '</b>'
          });
        }
      });
    });
    L
      .tileLayer(
        'http://{s}.tile.osm.org/{z}/{x}/{y}.png', {
          attribution: '&copy; <a href="http://osm.org/copyright">OpenStreetMap</a> contributors'
        }).addTo(map);
    map.on('click', function (e) {
      geocoder.reverse(e.latlng, map.options.crs.scale(map.getZoom()),
        function (results) {
          var r = results[0];

          if (r) {
            if (marker) {
              marker.setLatLng(r.center).setPopupContent(
                r.html || r.name).openPopup();
            } else {
              marker = L.marker(r.center).bindPopup(r.name)
                .addTo(map).openPopup();
            }
          }
        })
    })
  </script>
</body>

</html>